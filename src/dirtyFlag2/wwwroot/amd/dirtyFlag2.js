define(["require", "exports"], function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    var dirtyKeyRoots = [];
    var dirtyReg = ko.observableArray([]);
    var dirtyFlag2 = /** @class */ (function () {
        function dirtyFlag2(key) {
            if (key.length < 1)
                throw "Key must have at least one character e.g. VM or VM.TAB1";
            this.key = key;
            dirtyKeyRoots.push(key);
            this.isDirty = ko.pureComputed(function () {
                var firstDirty = ko.utils.arrayFirst(dirtyReg(), function (reg) {
                    return reg.key.indexOf(this.key) === 0 && reg.obs.isDirty();
                }, this);
                if (firstDirty) {
                    return true;
                }
                return false;
            }, this);
        }
        /**
         * Resets all values tracked by the dirtyflag
         * @param key If Provided resets only the value that matches exactly
         * @param cleanValue If Provided sets the clean value
         */
        dirtyFlag2.prototype.reset = function (key, cleanValue) {
            if (key) {
                ko.utils.arrayFirst(dirtyReg(), function (reg) {
                    return reg.key.localeCompare(key) === 0;
                }).obs.reset(cleanValue);
            }
            else {
                key = this.key;
                ko.utils.arrayForEach(dirtyReg(), function (reg) {
                    if (reg.key.indexOf(key) === 0) {
                        reg.obs.reset();
                    }
                });
            }
        };
        dirtyFlag2.prototype.dispose = function () {
            var key = this.key;
            dirtyKeyRoots.splice(dirtyKeyRoots.indexOf(key), 1);
            ko.utils.arrayForEach(dirtyReg(), function (reg) {
                if (reg.key.indexOf(key) === 0) {
                    reg.obs.unregister();
                }
            });
        };
        return dirtyFlag2;
    }());
    exports.dirtyFlag2 = dirtyFlag2;
    var nonValueTypes = ["undefined", "null"];
    var deepValueTypes = ["object"];
    /**
     * Compares 2 Arrays looking for anything that makes them not match (per dirtyFlag Rules)
     * @param arr1
     * @param arr2
     */
    function dirtyArrayCompare(arr1, arr2) {
        // Arrays of different length are never clean
        if (arr1.length !== arr2.length)
            return false;
        // Assume true
        var matches = true;
        for (var a = 0, l = arr1.length; a < l; a++) {
            // Check each member of the arry
            if (nonValueTypes.indexOf(typeof arr1[a]) >= 0 && nonValueTypes.indexOf(typeof arr2[a]) >= 0)
                matches = false;
            if (deepValueTypes.indexOf(typeof arr1[a]) >= 0 || deepValueTypes.indexOf(typeof arr2[a]) >= 0)
                throw "Objects cannot be used in dirtyFlag";
            if (arr1[a] !== arr2[a])
                matches = false;
            // If anything is false, stop checking rest of array
            if (!matches)
                break;
        }
        // Return Array Compare Result
        return matches;
    }
    ko.extenders['dirtyFlag'] = function (obs, options) {
        var reg;
        if (Array.isArray(obs())) {
            obs['clean'] = ko.observableArray(obs().slice());
        }
        else {
            if (deepValueTypes.indexOf(typeof obs()) >= 0)
                throw "Objects cannot be used in dirtyFlag";
            obs['clean'] = ko.observable(obs());
        }
        obs['isDirty'] = ko.pureComputed(function () {
            if (nonValueTypes.indexOf(typeof obs()) >= 0 && nonValueTypes.indexOf(typeof obs['clean']()) >= 0)
                return false;
            if (Array.isArray(obs()) && Array.isArray(obs['clean']())) {
                return !dirtyArrayCompare(obs(), obs['clean']());
            }
            if (deepValueTypes.indexOf(typeof obs()) >= 0 || deepValueTypes.indexOf(typeof obs['clean']()) >= 0)
                throw "Objects cannot be used in dirtyFlag";
            return obs() !== obs['clean']();
        });
        obs['reset'] = function (cleanValue) {
            var newClean = typeof cleanValue != "undefined" ? cleanValue : obs();
            obs['clean'](Array.isArray(newClean) ? newClean.slice() : newClean);
        };
        obs['unregister'] = function () {
            if (reg) {
                dirtyReg.remove(reg);
            }
        };
        if (options && typeof options.key === "string") {
            if (options.key.length < 1)
                throw "Key must have at least one character e.g. VM.FIELD1 or VM.TAB1.FIELD1";
            var rootMatch = ko.utils.arrayFirst(dirtyKeyRoots, function (keyRoot) {
                return options.key.indexOf(keyRoot) >= 0;
            });
            if (!rootMatch)
                throw "There is no DirtyFlag tracking at a root of the key '" + options.key + "'";
            var match = ko.utils.arrayFirst(dirtyReg(), function (item) {
                return item.key === options.key;
            });
            if (match)
                throw "Another item with dirtyFlag key of '" + options.key + "' is already being tracked.";
            reg = { key: options.key, obs: obs };
            dirtyReg.push(reg);
        }
        return obs;
    };
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RUFBRSxHQUFHLEVBQW1CLEdBQUcsRUFBRSxDQUFDO1lBQ3RELFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdEI7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUMsQ0FBQyIsImZpbGUiOiJkaXJ0eUZsYWcyLmpzIiwic291cmNlc0NvbnRlbnQiOlsidHlwZSBEaXJ0eVRyYWNrZWRPYnMgPSBLbm9ja291dE9ic2VydmFibGU8YW55PiAmIElEaXJ0eUl0ZW07XHJcblxyXG5pbnRlcmZhY2UgSURpcnR5SXRlbSB7XHJcbiAgICBjbGVhbjogS25vY2tvdXRPYnNlcnZhYmxlPGFueT47XHJcbiAgICBpc0RpcnR5OiBLbm9ja291dENvbXB1dGVkPGJvb2xlYW4+O1xyXG4gICAgcmVzZXQ6IChjbGVhblZhbHVlPzogYW55KSA9PiB2b2lkO1xyXG4gICAgdW5yZWdpc3RlcjogKCkgPT4gdm9pZDtcclxufVxyXG5cclxuaW50ZXJmYWNlIElEaXJ0eVJlZyB7XHJcbiAgICBrZXk6IHN0cmluZztcclxuICAgIG9iczogRGlydHlUcmFja2VkT2JzXHJcbn1cclxuXHJcbmludGVyZmFjZSBJRGlydHlGbGFnT3B0aW9ucyB7XHJcbiAgICBrZXk/OiBzdHJpbmc7XHJcbn1cclxuXHJcbnZhciBkaXJ0eUtleVJvb3RzOiBBcnJheTxzdHJpbmc+ID0gW107XHJcbnZhciBkaXJ0eVJlZyA6IEtub2Nrb3V0T2JzZXJ2YWJsZUFycmF5PElEaXJ0eVJlZz4gPSBrby5vYnNlcnZhYmxlQXJyYXkoW10pO1xyXG5cclxuZXhwb3J0IGNsYXNzIGRpcnR5RmxhZzIge1xyXG4gICAgcHJpdmF0ZSBrZXk6IHN0cmluZztcclxuICAgIGlzRGlydHk6IEtub2Nrb3V0T2JzZXJ2YWJsZTxib29sZWFuPjtcclxuICAgIGNvbnN0cnVjdG9yKGtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKGtleS5sZW5ndGggPCAxKVxyXG4gICAgICAgICAgICB0aHJvdyBcIktleSBtdXN0IGhhdmUgYXQgbGVhc3Qgb25lIGNoYXJhY3RlciBlLmcuIFZNIG9yIFZNLlRBQjFcIjtcclxuICAgICAgICB0aGlzLmtleSA9IGtleTtcclxuICAgICAgICBkaXJ0eUtleVJvb3RzLnB1c2goa2V5KTtcclxuICAgICAgICB0aGlzLmlzRGlydHkgPSBrby5wdXJlQ29tcHV0ZWQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBsZXQgZmlyc3REaXJ0eSA9IGtvLnV0aWxzLmFycmF5Rmlyc3QoZGlydHlSZWcoKSwgZnVuY3Rpb24gKHJlZykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZy5rZXkuaW5kZXhPZih0aGlzLmtleSkgPT09IDAgJiYgcmVnLm9icy5pc0RpcnR5KCk7XHJcbiAgICAgICAgICAgIH0sIHRoaXMpO1xyXG4gICAgICAgICAgICBpZiAoZmlyc3REaXJ0eSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0sIHRoaXMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVzZXRzIGFsbCB2YWx1ZXMgdHJhY2tlZCBieSB0aGUgZGlydHlmbGFnXHJcbiAgICAgKiBAcGFyYW0ga2V5IElmIFByb3ZpZGVkIHJlc2V0cyBvbmx5IHRoZSB2YWx1ZSB0aGF0IG1hdGNoZXMgZXhhY3RseVxyXG4gICAgICogQHBhcmFtIGNsZWFuVmFsdWUgSWYgUHJvdmlkZWQgc2V0cyB0aGUgY2xlYW4gdmFsdWVcclxuICAgICAqL1xyXG4gICAgcmVzZXQoa2V5Pzogc3RyaW5nLCBjbGVhblZhbHVlPzogYW55KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGtleSkge1xyXG4gICAgICAgICAgICBrby51dGlscy5hcnJheUZpcnN0KGRpcnR5UmVnKCksIGZ1bmN0aW9uIChyZWcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZWcua2V5LmxvY2FsZUNvbXBhcmUoa2V5KSA9PT0gMDtcclxuICAgICAgICAgICAgfSkub2JzLnJlc2V0KGNsZWFuVmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGtleSA9IHRoaXMua2V5O1xyXG4gICAgICAgICAgICBrby51dGlscy5hcnJheUZvckVhY2goZGlydHlSZWcoKSwgZnVuY3Rpb24gKHJlZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlZy5rZXkuaW5kZXhPZihrZXkpID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVnLm9icy5yZXNldCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgICAgICB2YXIga2V5ID0gdGhpcy5rZXk7XHJcbiAgICAgICAgZGlydHlLZXlSb290cy5zcGxpY2UoZGlydHlLZXlSb290cy5pbmRleE9mKGtleSksIDEpO1xyXG4gICAgICAgIGtvLnV0aWxzLmFycmF5Rm9yRWFjaChkaXJ0eVJlZygpLCBmdW5jdGlvbiAocmVnKSB7XHJcbiAgICAgICAgICAgIGlmIChyZWcua2V5LmluZGV4T2Yoa2V5KSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmVnLm9icy51bnJlZ2lzdGVyKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuY29uc3Qgbm9uVmFsdWVUeXBlcyA9IFtcInVuZGVmaW5lZFwiLCBcIm51bGxcIl07XHJcbmNvbnN0IGRlZXBWYWx1ZVR5cGVzID0gW1wib2JqZWN0XCJdO1xyXG5cclxuLyoqXHJcbiAqIENvbXBhcmVzIDIgQXJyYXlzIGxvb2tpbmcgZm9yIGFueXRoaW5nIHRoYXQgbWFrZXMgdGhlbSBub3QgbWF0Y2ggKHBlciBkaXJ0eUZsYWcgUnVsZXMpXHJcbiAqIEBwYXJhbSBhcnIxXHJcbiAqIEBwYXJhbSBhcnIyXHJcbiAqL1xyXG5mdW5jdGlvbiBkaXJ0eUFycmF5Q29tcGFyZShhcnIxOiBBcnJheTxhbnk+LCBhcnIyOiBBcnJheTxhbnk+KSA6IGJvb2xlYW4ge1xyXG4gICAgLy8gQXJyYXlzIG9mIGRpZmZlcmVudCBsZW5ndGggYXJlIG5ldmVyIGNsZWFuXHJcbiAgICBpZiAoYXJyMS5sZW5ndGggIT09IGFycjIubGVuZ3RoKVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIC8vIEFzc3VtZSB0cnVlXHJcbiAgICBsZXQgbWF0Y2hlcyA9IHRydWU7XHJcbiAgICBmb3IgKGxldCBhID0gMCwgbCA9IGFycjEubGVuZ3RoOyBhIDwgbDsgYSsrKSB7XHJcbiAgICAgICAgLy8gQ2hlY2sgZWFjaCBtZW1iZXIgb2YgdGhlIGFycnlcclxuICAgICAgICBpZiAobm9uVmFsdWVUeXBlcy5pbmRleE9mKHR5cGVvZiBhcnIxW2FdKSA+PSAwICYmIG5vblZhbHVlVHlwZXMuaW5kZXhPZih0eXBlb2YgYXJyMlthXSkgPj0gMClcclxuICAgICAgICAgICAgbWF0Y2hlcyA9IGZhbHNlO1xyXG4gICAgICAgIGlmIChkZWVwVmFsdWVUeXBlcy5pbmRleE9mKHR5cGVvZiBhcnIxW2FdKSA+PSAwIHx8IGRlZXBWYWx1ZVR5cGVzLmluZGV4T2YodHlwZW9mIGFycjJbYV0pID49IDApXHJcbiAgICAgICAgICAgIHRocm93IFwiT2JqZWN0cyBjYW5ub3QgYmUgdXNlZCBpbiBkaXJ0eUZsYWdcIjtcclxuICAgICAgICBpZiAoYXJyMVthXSAhPT0gYXJyMlthXSlcclxuICAgICAgICAgICAgbWF0Y2hlcyA9IGZhbHNlO1xyXG4gICAgICAgIC8vIElmIGFueXRoaW5nIGlzIGZhbHNlLCBzdG9wIGNoZWNraW5nIHJlc3Qgb2YgYXJyYXlcclxuICAgICAgICBpZiAoIW1hdGNoZXMpXHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgLy8gUmV0dXJuIEFycmF5IENvbXBhcmUgUmVzdWx0XHJcbiAgICByZXR1cm4gbWF0Y2hlcztcclxufVxyXG5cclxua28uZXh0ZW5kZXJzWydkaXJ0eUZsYWcnXSA9IGZ1bmN0aW9uIChvYnM6IEtub2Nrb3V0T2JzZXJ2YWJsZTxhbnk+LCBvcHRpb25zOiBJRGlydHlGbGFnT3B0aW9ucykge1xyXG4gICAgbGV0IHJlZzogSURpcnR5UmVnO1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkob2JzKCkpKSB7XHJcbiAgICAgICAgb2JzWydjbGVhbiddID0ga28ub2JzZXJ2YWJsZUFycmF5KG9icygpLnNsaWNlKCkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoZGVlcFZhbHVlVHlwZXMuaW5kZXhPZih0eXBlb2Ygb2JzKCkpID49IDApXHJcbiAgICAgICAgICAgIHRocm93IFwiT2JqZWN0cyBjYW5ub3QgYmUgdXNlZCBpbiBkaXJ0eUZsYWdcIjtcclxuICAgICAgICBvYnNbJ2NsZWFuJ10gPSBrby5vYnNlcnZhYmxlKG9icygpKTtcclxuICAgIH1cclxuICAgIG9ic1snaXNEaXJ0eSddID0ga28ucHVyZUNvbXB1dGVkKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAobm9uVmFsdWVUeXBlcy5pbmRleE9mKHR5cGVvZiBvYnMoKSkgPj0gMCAmJiBub25WYWx1ZVR5cGVzLmluZGV4T2YodHlwZW9mIG9ic1snY2xlYW4nXSgpKSA+PSAwKVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JzKCkpICYmIEFycmF5LmlzQXJyYXkob2JzWydjbGVhbiddKCkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhZGlydHlBcnJheUNvbXBhcmUob2JzKCksIG9ic1snY2xlYW4nXSgpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGRlZXBWYWx1ZVR5cGVzLmluZGV4T2YodHlwZW9mIG9icygpKSA+PSAwIHx8IGRlZXBWYWx1ZVR5cGVzLmluZGV4T2YodHlwZW9mIG9ic1snY2xlYW4nXSgpKSA+PSAwKVxyXG4gICAgICAgICAgICB0aHJvdyBcIk9iamVjdHMgY2Fubm90IGJlIHVzZWQgaW4gZGlydHlGbGFnXCI7XHJcbiAgICAgICAgcmV0dXJuIG9icygpICE9PSBvYnNbJ2NsZWFuJ10oKTtcclxuICAgIH0pO1xyXG4gICAgb2JzWydyZXNldCddID0gZnVuY3Rpb24gKGNsZWFuVmFsdWUpIHtcclxuICAgICAgICBsZXQgbmV3Q2xlYW4gPSB0eXBlb2YgY2xlYW5WYWx1ZSAhPSBcInVuZGVmaW5lZFwiID8gY2xlYW5WYWx1ZSA6IG9icygpO1xyXG4gICAgICAgIG9ic1snY2xlYW4nXShBcnJheS5pc0FycmF5KG5ld0NsZWFuKSA/IG5ld0NsZWFuLnNsaWNlKCkgOiBuZXdDbGVhbik7XHJcbiAgICB9O1xyXG4gICAgb2JzWyd1bnJlZ2lzdGVyJ10gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHJlZykge1xyXG4gICAgICAgICAgICBkaXJ0eVJlZy5yZW1vdmUocmVnKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMua2V5ID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgaWYgKG9wdGlvbnMua2V5Lmxlbmd0aCA8IDEpXHJcbiAgICAgICAgICAgIHRocm93IFwiS2V5IG11c3QgaGF2ZSBhdCBsZWFzdCBvbmUgY2hhcmFjdGVyIGUuZy4gVk0uRklFTEQxIG9yIFZNLlRBQjEuRklFTEQxXCI7XHJcbiAgICAgICAgbGV0IHJvb3RNYXRjaCA9IGtvLnV0aWxzLmFycmF5Rmlyc3QoZGlydHlLZXlSb290cywgZnVuY3Rpb24gKGtleVJvb3QpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMua2V5LmluZGV4T2Yoa2V5Um9vdCkgPj0gMDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoIXJvb3RNYXRjaClcclxuICAgICAgICAgICAgdGhyb3cgXCJUaGVyZSBpcyBubyBEaXJ0eUZsYWcgdHJhY2tpbmcgYXQgYSByb290IG9mIHRoZSBrZXkgJ1wiICsgb3B0aW9ucy5rZXkgKyBcIidcIjtcclxuICAgICAgICBsZXQgbWF0Y2ggPSBrby51dGlscy5hcnJheUZpcnN0KGRpcnR5UmVnKCksIGZ1bmN0aW9uIChpdGVtKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpdGVtLmtleSA9PT0gb3B0aW9ucy5rZXk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKG1hdGNoKVxyXG4gICAgICAgICAgICB0aHJvdyBcIkFub3RoZXIgaXRlbSB3aXRoIGRpcnR5RmxhZyBrZXkgb2YgJ1wiICsgb3B0aW9ucy5rZXkgKyBcIicgaXMgYWxyZWFkeSBiZWluZyB0cmFja2VkLlwiO1xyXG4gICAgICAgIHJlZyA9IHsga2V5OiBvcHRpb25zLmtleSwgb2JzOiA8RGlydHlUcmFja2VkT2JzPm9icyB9O1xyXG4gICAgICAgIGRpcnR5UmVnLnB1c2gocmVnKTtcclxuICAgIH1cclxuICAgIHJldHVybiBvYnM7XHJcbn07Il19
